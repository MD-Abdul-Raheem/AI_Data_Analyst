<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AI Data Analyst - 15-Stage Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 3em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .upload-section { background: white; border-radius: 15px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 30px; }
        .upload-zone { border: 3px dashed #667eea; border-radius: 10px; padding: 60px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover { background: #f8f9ff; border-color: #764ba2; }
        .upload-zone.dragover { background: #e8ebff; border-color: #667eea; }
        .file-input { display: none; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .progress { display: none; margin-top: 20px; }
        .progress-bar { width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s; text-align: center; color: white; line-height: 30px; }
        .results { display: none; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .tabs { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .tab-btn { background: #f5f5f5; border: none; padding: 12px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.95em; transition: all 0.3s; }
        .tab-btn:hover { background: #e8ebff; }
        .tab-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .stat-card h3 { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; }
        .stat-card .value { font-size: 2em; font-weight: bold; }
        .chart-container { margin: 20px 0; text-align: center; }
        .chart-container img { max-width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .code-block { background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 8px; overflow-x: auto; margin: 15px 0; position: relative; }
        .code-block pre { margin: 0; white-space: pre-wrap; }
        .copy-btn { position: absolute; top: 10px; right: 10px; background: #667eea; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85em; }
        .copy-btn:hover { background: #764ba2; }
        .formula-grid { display: grid; gap: 15px; margin: 20px 0; }
        .formula-card { background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; }
        .formula-card h4 { color: #667eea; margin-bottom: 8px; }
        .formula-card code { background: #2d2d2d; color: #f8f8f2; padding: 5px 10px; border-radius: 4px; display: inline-block; margin: 5px 0; }
        .insight-list { list-style: none; }
        .insight-list li { background: #f8f9ff; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea; }
        .insight-list li:before { content: "üí° "; font-size: 1.2em; margin-right: 10px; }
        .ai-insight { background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 25px; border-radius: 10px; margin: 20px 0; border: 2px solid #667eea; }
        .ai-insight h3 { color: #667eea; margin-bottom: 15px; }
        .error { background: #ff4444; color: white; padding: 15px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Enhanced AI Data Analyst</h1>
            <p>15-Stage Comprehensive Analysis | Excel ‚Ä¢ Statistics ‚Ä¢ ML ‚Ä¢ AI Insights</p>
        </div>

        <div class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <h2>üìä Upload Your Dataset</h2>
                <p>Drag & drop or click to select CSV, Excel, or JSON file</p>
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls,.json">
            </div>
            <div class="progress" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="tabs" id="tabs">
                <button class="tab-btn active" data-tab="summary">üìã Summary</button>
                <button class="tab-btn" data-tab="insights">üí° Insights</button>
                <button class="tab-btn" data-tab="cleaning">üßπ Cleaning</button>
                <button class="tab-btn" data-tab="stats">üìà Statistics</button>
                <button class="tab-btn" data-tab="charts">üé® Charts</button>
                <button class="tab-btn" data-tab="excel">üìê Excel Formulas</button>
                <button class="tab-btn" data-tab="advanced-stats">üìä Advanced Stats</button>
                <button class="tab-btn" data-tab="ml">ü§ñ Machine Learning</button>
                <button class="tab-btn" data-tab="hypothesis">üî¨ Hypothesis Testing</button>
                <button class="tab-btn" data-tab="ai">üß† AI Insights</button>
            </div>

            <div id="summary" class="tab-content active"></div>
            <div id="insights" class="tab-content"></div>
            <div id="cleaning" class="tab-content"></div>
            <div id="stats" class="tab-content"></div>
            <div id="charts" class="tab-content"></div>
            <div id="excel" class="tab-content"></div>
            <div id="advanced-stats" class="tab-content"></div>
            <div id="ml" class="tab-content"></div>
            <div id="hypothesis" class="tab-content"></div>
            <div id="ai" class="tab-content"></div>
        </div>
    </div>

    <script>
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const results = document.getElementById('results');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload();
            }
        });
        fileInput.addEventListener('change', handleFileUpload);

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        async function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;

            progress.style.display = 'block';
            results.style.display = 'none';
            progressFill.style.width = '30%';
            progressFill.textContent = 'Analyzing...';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                progressFill.style.width = '70%';

                if (!response.ok) throw new Error('Analysis failed');

                const data = await response.json();
                progressFill.style.width = '100%';
                progressFill.textContent = 'Complete!';

                setTimeout(() => {
                    progress.style.display = 'none';
                    displayResults(data);
                }, 500);

            } catch (error) {
                progress.style.display = 'none';
                alert('Error: ' + error.message);
            }
        }

        function displayResults(data) {
            results.style.display = 'block';

            // Summary
            document.getElementById('summary').innerHTML = `
                <h2>üìã Executive Summary</h2>
                <div class="stat-grid">
                    <div class="stat-card">
                        <h3>Total Records</h3>
                        <div class="value">${data.understanding.shape[0].toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Columns</h3>
                        <div class="value">${data.understanding.shape[1]}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Memory Usage</h3>
                        <div class="value">${data.understanding.memory_usage.toFixed(2)} MB</div>
                    </div>
                    <div class="stat-card">
                        <h3>Analysis Stages</h3>
                        <div class="value">15</div>
                    </div>
                </div>
                <p style="margin-top: 20px; font-size: 1.1em;">${data.executive_summary}</p>
            `;

            // Insights
            document.getElementById('insights').innerHTML = `
                <h2>üí° Key Insights</h2>
                <ul class="insight-list">
                    ${data.insights.map(insight => `<li>${insight}</li>`).join('')}
                </ul>
            `;

            // Cleaning
            document.getElementById('cleaning').innerHTML = `
                <h2>üßπ Data Cleaning Report</h2>
                <h3>Missing Values</h3>
                <div class="formula-grid">
                    ${Object.entries(data.cleaning.missing_values).map(([col, info]) => `
                        <div class="formula-card">
                            <h4>${col}</h4>
                            <p>Count: ${info.count} (${info.percentage})</p>
                        </div>
                    `).join('')}
                </div>
                <h3>Outliers Detected (IQR Method)</h3>
                <div class="formula-grid">
                    ${Object.entries(data.cleaning.outliers_detected.iqr_method).map(([col, count]) => `
                        <div class="formula-card">
                            <h4>${col}</h4>
                            <p>Outliers: ${count}</p>
                        </div>
                    `).join('')}
                </div>
            `;

            // Statistics
            let statsHTML = '<h2>üìà Descriptive Statistics</h2>';
            Object.entries(data.eda.descriptive_stats).forEach(([col, stats]) => {
                statsHTML += `
                    <div class="formula-card">
                        <h4>${col}</h4>
                        <p>Mean: ${stats.mean.toFixed(2)} | Median: ${stats.median.toFixed(2)} | Std: ${stats.std.toFixed(2)}</p>
                        <p>Skewness: ${stats.skewness.toFixed(2)} | Kurtosis: ${stats.kurtosis.toFixed(2)}</p>
                    </div>
                `;
            });
            document.getElementById('stats').innerHTML = statsHTML;

            // Charts
            document.getElementById('charts').innerHTML = `
                <h2>üé® Visualizations</h2>
                ${data.charts.map(chart => `
                    <div class="chart-container">
                        <h3>${chart.title}</h3>
                        <img src="data:image/png;base64,${chart.image}" alt="${chart.title}">
                    </div>
                `).join('')}
            `;

            // Excel Formulas
            let excelHTML = '<h2>üìê Excel Functions & Formulas</h2>';
            excelHTML += '<h3>Aggregation Functions</h3><div class="formula-grid">';
            data.excel_formulas.aggregation.forEach(f => {
                excelHTML += `
                    <div class="formula-card">
                        <h4>${f.function}</h4>
                        <code>${f.formula}</code>
                        <p>${f.use}</p>
                    </div>
                `;
            });
            excelHTML += '</div><h3>Conditional Logic</h3><div class="formula-grid">';
            data.excel_formulas.conditional.forEach(f => {
                excelHTML += `
                    <div class="formula-card">
                        <h4>${f.function}</h4>
                        <code>${f.formula}</code>
                        <p>${f.use}</p>
                    </div>
                `;
            });
            excelHTML += '</div>';
            document.getElementById('excel').innerHTML = excelHTML;

            // Advanced Stats
            let advStatsHTML = '<h2>üìä Advanced Statistical Analysis</h2>';
            advStatsHTML += '<h3>Normality Tests</h3><div class="formula-grid">';
            Object.entries(data.advanced_stats.normality_tests).forEach(([col, test]) => {
                advStatsHTML += `
                    <div class="formula-card">
                        <h4>${col}</h4>
                        <p>Shapiro-Wilk p-value: ${test.p_value.toFixed(4)}</p>
                        <p>Distribution: ${test.interpretation}</p>
                    </div>
                `;
            });
            advStatsHTML += '</div>';
            document.getElementById('advanced-stats').innerHTML = advStatsHTML;

            // ML
            document.getElementById('ml').innerHTML = `
                <h2>ü§ñ Machine Learning Analysis</h2>
                <h3>Problem Type: ${data.ml_analysis.problem_type || 'Clustering'}</h3>
                <div class="formula-grid">
                    ${data.ml_analysis.algorithms.map(algo => `
                        <div class="formula-card">
                            <h4>${algo.name}</h4>
                            <p>${algo.use}</p>
                            <p>Complexity: ${algo.complexity}</p>
                        </div>
                    `).join('')}
                </div>
                <h3>Implementation Code</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>${data.ml_analysis.code}</pre>
                </div>
            `;

            // Hypothesis Testing
            let hypHTML = '<h2>üî¨ Hypothesis Testing & Regression</h2>';
            hypHTML += '<h3>Suggested Hypotheses</h3><ul class="insight-list">';
            data.hypothesis_testing.suggested_hypotheses.forEach(h => {
                hypHTML += `<li><strong>${h.h0}</strong><br>${h.test}</li>`;
            });
            hypHTML += '</ul>';
            if (data.hypothesis_testing.regression.equation) {
                hypHTML += `
                    <h3>Linear Regression</h3>
                    <div class="formula-card">
                        <h4>Regression Equation</h4>
                        <code>${data.hypothesis_testing.regression.equation}</code>
                        <p>R¬≤ Score: ${data.hypothesis_testing.regression.r_squared.toFixed(4)}</p>
                    </div>
                `;
            }
            document.getElementById('hypothesis').innerHTML = hypHTML;

            // AI Insights
            document.getElementById('ai').innerHTML = `
                <h2>üß† AI-Powered Insights (${data.ai_insights.generated_by})</h2>
                <div class="ai-insight">
                    <pre style="white-space: pre-wrap; font-family: inherit;">${data.ai_insights.ai_insights}</pre>
                </div>
            `;
        }

        function copyCode(btn) {
            const code = btn.nextElementSibling.textContent;
            navigator.clipboard.writeText(code);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 2000);
        }
    </script>
</body>
</html>
